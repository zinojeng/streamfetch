# 視頻流捕獲工具開發進度報告

## 項目概述

本項目旨在開發一個使用 Puppeteer 的視頻流捕獲工具，能夠從網頁中檢測、捕獲和下載視頻內容。特別專注於處理流媒體視頻，包括分段視頻和 HLS 流。

## 開發進度

### 階段一：基本功能實現

- [x] 設置 Puppeteer 環境和基本架構
- [x] 實現網頁導航和自動檢測視頻元素
- [x] 捕獲基本 MP4 視頻連結
- [x] 實現文件下載功能
- [x] 添加文件排序和命名機制

### 階段二：增強流媒體支持

- [x] 實現網絡請求攔截和分析
- [x] 改進視頻檢測邏輯，支持更多格式
- [x] 添加 HLS 流媒體 (.m3u8) 支持
- [x] 實現視頻片段下載和管理
- [x] 添加下載重試機制

### 階段三：合併和後處理

- [x] 嘗試使用 FFmpeg 合併視頻片段
- [x] 探索二進制合併方法
- [ ] 實現完整視頻重建
- [ ] 添加字幕和音頻同步

## 技術難點與解決方案

### 1. 視頻片段檢測問題

**問題描述**：
初期版本無法區分完整 MP4 文件和視頻片段，導致下載了大量無法直接播放的片段文件。

**解決方案**：
- 創建 `isCompleteVideoUrl` 函數來篩選 URL
- 建立排除模式列表 (如 'range=', 'segment', 'frag' 等關鍵字)
- 增強檢測邏輯，檢查內容類型和文件擴展名

### 2. 自動播放問題

**問題描述**：
許多網站有自動播放限制，導致腳本無法觸發視頻播放，進而無法捕獲視頻流。

**解決方案**：
- 使用多種選擇器尋找播放按鈕
- 實現多種點擊和播放策略
- 添加 `--autoplay-policy=no-user-gesture-required` 參數
- 在 iframe 中尋找視頻元素

### 3. 視頻片段合併問題

**問題描述**：
下載的視頻片段無法使用標準方法直接合併，FFmpeg 報錯 "could not find corresponding trex" 和 "error reading header"。

**嘗試解決方案**：
- 使用 FFmpeg 的 concat 功能嘗試合併（失敗）
- 嘗試二進制合併方法（部分成功）
- 分離處理音頻和視頻流（部分成功）

**未解決**：標準 MP4 合併方法不適用於當前的片段文件格式。

## 當前存在的問題

1. **視頻片段合併問題**：
   - 下載的視頻片段是流媒體格式（fMP4）而非標準 MP4 檔案
   - 缺少完整文件頭信息，無法直接用標準工具合併
   - 合併後的文件無法正常播放

2. **音視頻同步問題**：
   - 音頻和視頻經常分開傳輸
   - 合併後可能出現不同步現象

3. **特殊流媒體格式支持**：
   - 部分網站使用專有保護措施或加密格式
   - 不同網站的視頻結構差異大，難以通用化處理

## 下一步工作計劃

### 近期任務

1. **研究 cat-catch 實現方式**：
   - 分析其處理流媒體片段的方法
   - 了解其如何處理 fMP4 和其他格式

2. **改進流媒體處理**：
   - 實現更完善的 HLS/DASH 流解析器
   - 開發專門的 fMP4 處理模塊

3. **探索更多後處理方法**：
   - 研究使用 MP4Box 或其他專業工具處理片段
   - 實現直接將流片段轉換為標準格式

### 中期目標

1. **擴展媒體類型支持**：
   - 添加對更多視頻格式的支持
   - 實現音頻捕獲和下載功能

2. **用戶界面開發**：
   - 添加簡單的 Web 控制界面
   - 提供下載進度和預覽功能

3. **批量處理功能**：
   - 支持同時處理多個網頁
   - 添加下載隊列和管理功能

### 長期計劃

1. **開發為瀏覽器擴展**：
   - 參考 cat-catch 的擴展模式
   - 提供更便捷的用戶體驗

2. **添加智能識別功能**：
   - 使用啟發式算法自動識別最佳質量的視頻源
   - 實現自動選擇最佳下載策略

## 資源與參考

1. **參考項目**：
   - [cat-catch](https://github.com/xifangczy/cat-catch): 瀏覽器資源嗅探擴展
   - Puppeteer 官方文檔和示例

2. **有用工具**：
   - FFmpeg: 視頻處理工具
   - MP4Box: MP4 處理專家工具
   - VLC: 測試和播放視頻

## 技術筆記

### MP4 片段 vs 完整 MP4 文件

MP4 片段（fMP4）不同於標準 MP4 文件：
- 缺少完整的文件頭和元數據
- 通常包含 "moof" (Movie Fragment) 標記
- 設計用於流媒體傳輸，而非獨立播放
- 需要特殊處理才能恢復為標準播放格式

### HLS 流處理注意事項

M3U8 文件是索引文件，指向實際的視頻片段：
- 需要解析播放列表獲取所有片段 URL
- 處理相對路徑和絕對路徑的轉換
- 需要按順序下載並合併片段
- 可能有不同清晰度和比特率的變體 